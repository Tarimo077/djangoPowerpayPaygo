{% extends "layout.html" %}

{% block title %} Powerpay Africa: Live Window {% endblock %}

{% block content %}
<h1>Live Data Stream for Device: {{ deviceID }}</h1>

<div id="device-info">
    <h3>Device ID: <span id="device-id">{{ deviceID }}</span></h3>
    <label>‚ûï Data Count: <span id="count">0</span></label>
    <label>üç≥ Cooking Time: <span id="cooking">0 sec</span></label>
    <label>‚ö° Energy: <span id="kwh">0 kWh</span></label>
    <label>ü§ë Cost: <span id="cost">KSH. 0.00</span></label>
    <label>üè≠ Emissions: <span id="co2">0.00 kg CO‚ÇÇ</span></label>
    <p id="status" style="color: red;">üî¥ Disconnected</p>
</div>

<div id="messages"></div>

<script>
  let deviceID = "{{ deviceID }}";
  const COST_PER_KWH = 33.0;
  const CO2_PER_KWH = 0.4999 * 0.28;
  
  let count = 0;
  let totalKwh = 0;
  let startTime = null;
  let socket = null;
  let retryAttempts = 0;

  const processedMessages = new Set();
  const messagesDiv = document.getElementById("messages");

  function connectWebSocket() {
    if (retryAttempts >= 10) {
      console.error("üõë Max reconnect attempts reached. Stopping retries.");
      return;
    }

    socket = new WebSocket(`ws://127.0.0.1:8000/ws/mqtt/${deviceID}/`);

    socket.onopen = function () {
      console.log(`‚úÖ Connected to WebSocket for device: ${deviceID}`);
      document.getElementById("status").textContent = "üü¢ Connected";
      document.getElementById("status").style.color = "green";
      retryAttempts = 0; // Reset retry attempts on successful connection
    };

    socket.onmessage = function (event) {
      try {
        const data = JSON.parse(event.data);
        const message = JSON.parse(data.message);
        
        if (message.deviceID !== deviceID) return;

        const kWh = parseFloat(message.kwh) || 0;
        const uniqueId = `${message.txtime}-${deviceID}`;

        if (!processedMessages.has(uniqueId)) {
          processedMessages.add(uniqueId);

          count++;
          totalKwh += kWh;
          if (!startTime) startTime = new Date();
          const cookingTime = ((new Date() - startTime) / 1000).toFixed(0);

          document.getElementById("count").textContent = count;
          document.getElementById("cooking").textContent = `${cookingTime} sec`;
          document.getElementById("kwh").textContent = `${totalKwh.toFixed(2)} kWh`;
          document.getElementById("cost").textContent = `KSH. ${(totalKwh * COST_PER_KWH).toFixed(2)}`;
          document.getElementById("co2").textContent = `${(totalKwh * CO2_PER_KWH).toFixed(2)} kg CO‚ÇÇ`;

          const messageDiv = document.createElement("div");
          messageDiv.className = "message";
          messageDiv.textContent = data.message;
          messagesDiv.appendChild(messageDiv);

          if (messagesDiv.children.length > 50) {
            messagesDiv.removeChild(messagesDiv.firstChild);
          }
        }
      } catch (error) {
        console.error("‚ùå Error parsing message:", error);
      }
    };

    socket.onerror = function (error) {
      console.error("‚ö†Ô∏è WebSocket error:", error);
    };

    socket.onclose = function (event) {
      console.warn("‚ö†Ô∏è WebSocket closed:", event);
      document.getElementById("status").textContent = "üî¥ Disconnected";
      document.getElementById("status").style.color = "red";
      
      let retryDelay = Math.min(1000 * (2 ** retryAttempts), 30000); // Exponential backoff (max 30s)
      retryAttempts++;

      console.log(`‚ôªÔ∏è Reconnecting in ${retryDelay / 1000} seconds...`);
      setTimeout(connectWebSocket, retryDelay);
    };
  }

  connectWebSocket(); // Start WebSocket connection
</script>

<style>
  #device-info {
    border: 2px solid #0ead00;
    padding: 15px;
    width: 300px;
    background: white;
    border-radius: 10px;
  }
  #messages {
    max-height: 200px;
    overflow-y: auto;
    border-top: 2px solid #0ead00;
    margin-top: 10px;
    padding-top: 5px;
  }
  .message {
    padding: 10px;
    border-bottom: 1px solid #0ead00;
    font-size: 14px;
  }
  label {
    display: block;
    font-size: 16px;
    margin-top: 5px;
  }
  span {
    color: #0ead00;
    font-weight: bold;
  }
</style>

{% endblock %}
